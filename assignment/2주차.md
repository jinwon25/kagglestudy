# 2주차 Porto Seguro’s Safe Driver Prediction 캐글 필사

## 참고 노트북

[Porto Seguro Tutorial: end-to-end ensemble - Yifan Xie](https://www.kaggle.com/code/yifanxie/porto-seguro-tutorial-end-to-end-ensemble#4.-Level-2-ensemble)


## 내용 정리

### `Feature Engineering` - 빈도/바이너리 인코딩 + 피처 축소

#### 빈도 인코딩 함수

```PYTHON
def freq_encoding(cols, train_df, test_df):

  result_train_df=pd.DataFrame()
  result_test_df=pd.DataFrame()

  for col in cols:

    col_freq=col+'_freq'
    freq=train_df[col].value_counts()
    freq=pd.DataFrame(freq)
    freq.reset_index(inplace=True)
    freq.columns=[col, col_freq]

    temp_train_df=pd.merge(train_df[[col]], freq, how='left', on=col)
    temp_train_df.drop([col], axis=1, inplace=True)

    temp_test_df=pd.merge(test_df[[col]], freq, how='left', on=col)
    temp_test_df.drop([col], axis=1, inplace=True)

    temp_test_df.fillna(0, inplace=True)
    temp_test_df[col_freq]=temp_test_df[col_freq].astype(np.int32)

    if result_train_df.shape[0]==0:
      result_train_df=temp_train_df
      result_test_df=temp_test_df
    else:
      result_train_df=pd.concat([result_train_df, temp_train_df], axis=1)
      result_test_df=pd.concat([result_test_df, temp_test_df], axis=1)

  return result_train_df, result_test_df
```

- 각 범주형 변수 값을 빈도수로 대체
- train/test 모두 동일하게 처리하며 test에 없는 값은 0으로 대체

#### 바이너리 인코딩 함수

```PYTHON
def binary_encoding(train_df, test_df, feat):

  train_feat_max = train_df[feat].max()
  test_feat_max = test_df[feat].max()
  if train_feat_max > test_feat_max:
    feat_max = train_feat_max
  else:
    feat_max = test_feat_max

  train_df.loc[train_df[feat] == -1, feat] = feat_max + 1
  test_df.loc[test_df[feat] == -1, feat] = feat_max + 1

  union_val = np.union1d(train_df[feat].unique(), test_df[feat].unique())

  max_dec = union_val.max()

  max_bin_len = len("{0:b}".format(max_dec))
  index = np.arange(len(union_val))
  columns = list([feat])

  bin_df = pd.DataFrame(index=index, columns=columns)
  bin_df[feat] = union_val

  feat_bin = bin_df[feat].apply(lambda x: "{0:b}".format(x).zfill(max_bin_len))

  splitted = feat_bin.apply(lambda x: pd.Series(list(x)).astype(np.uint8))
  splitted.columns = [feat + '_bin_' + str(x) for x in splitted.columns]
  bin_df = bin_df.join(splitted)

  train_df = pd.merge(train_df, bin_df, how='left', on=[feat])
  test_df = pd.merge(test_df, bin_df, how='left', on=[feat])
  return train_df, test_df
```

- 범주형 변수 값들을 이진수로 변환하여 새로운 변수 생성

#### 피처 제거

```PYTHON
col_to_drop = train.columns[train.columns.str.startswith('ps_calc_')]
train.drop(col_to_drop, axis=1, inplace=True)  
test.drop(col_to_drop, axis=1, inplace=True)
```

- 의미 없는 계산 피처 `(ps_calc_)` 제거로 차원 축소

### `K-Fold 교차검증` + `OOF 예측 함수 구현`

```PYTHON
def auc_to_gini_norm(auc_score):
  return 2*auc_score-1
```
